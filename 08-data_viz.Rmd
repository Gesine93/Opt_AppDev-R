# Data visualisation

R has a very rich set of graphical functions. The [R Graph Gallery](https://www.r-graph-gallery.com/){target="_blank"} provides a large number of examples (including code).  

```{block2, type = 'rmdtip'}
In this lesson you will get to know the [`ggplot2` library](https://ggplot2.tidyverse.org/){target="_blank"}, which is the most popular library for creating graphics in R. You will learn to create standard graphs such as histograms, boxplots or scatterplots. Furthermore, map making in R will be introduced. 
```

## The Grammar of graphics

The [ggplot2 library](https://ggplot2.tidyverse.org/){target="_blank"} is part of [Tidyverse](https://www.tidyverse.org/){target="_blank"} and offers a series of functions for creating graphics declaratively, based on the concepts outlined in the Grammar of Graphics by Leland Wilkinson.

The grammar of graphics is a schema that enables us to concisely describe the components of a graphic. These components are called **layers of grammatical elements.** Overall the grammar comprises seven layers:

1) Data - The data element is the dataset itself.
2) Aesthetics - This layer defines how variables are mapped onto scales (see description below).
3) Geometries - This element determines how our data is being displayed (bars, points, lines)
4) Facets - Facetting splits the data into subset and displays the same graph for every subset.
5) Statistics - These are statistics derived from the data (add mean, median, quartile).
6) Coordinates - This element determines the transformation of axes (e.g. change spacing of displayed data)
7) Themes - This element determines the graphics background.

The **aestethics layer** offers a number of different options to map data onto visual variables. A **visual variable** is an aspect of a **mark** that can be controlled to change its appearance.

Visual variables are: 

- Size
- Shape 
- Orientation
- Colour (hue)
- Colour value (brightness)
- Texture
- Position (map variable to x or y axis) 

For instance, in Figure \@ref(fig:L07-colsize) variables 'Gdp per capita' and  'Life Expectancy' are mapped onto the x and y axes, variables 'national population' and 'world regions' are mapped onto visual variables size and color.

```{r L07-colsize, echo=FALSE, fig.cap="Visual variables color and size", out.width='90%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/VisualVar.png')
```

In order to make that concepts clearer, a number of examples will me presented in upcoming sections.

```{block2, type = 'rmdtip'}
The basic concept behind the grammar of graphics is described in an [article](https://byrneslab.net/classes/biol607/readings/wickham_layered-grammar.pdf){target="_blank"} by Hadley Wickham.  
```

## Visualization of distributions

As already announced above, functions in the `ggplot2` library are structured according to the Grammar of Graphics. To create a graph in `ggplot2`, we need to provide input data, specify visual variables by means of an aesthetics element (`aes()`), specify the geometry of marks (e.g., `geom_point`) and apply transformations (axis spacing) and themes (background theme of the graph).

We start the analysis with a simple histogram, to explore the distribution of air quality [data](data/AirQualityUpperAut.csv){target="_blank"} that has been measured at different locations in Upper Austria.

```{block2, type = 'rmdtip'}

The data includes the following **variables**

- **time** of measurement
- ID of the measuring **station**
- measured meteorological [**component**](data/MetadataAirqual.xlsx){target="_blank"}
- [**meantype**](data/MetadataAirqual2.xlsx){target="_blank"}
- **unit** of measurement
- measurement **value**
  
```

The following code renders the first five lines of the dataset:

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.height = 4}

library(tidyverse)
library(knitr)

#read csv data, Note: Semicolon seperated CSVs can be loaded by function 'read_delim()'
airquality <- read_delim("data/AirQualityUpperAut.csv", delim = ";")

airquality %>%
  dplyr::slice_head(n = 5) %>%
  knitr::kable()

```

The code below filters the airquality datset by measurement component and temporal resolution. Then the data subset is passed as a first argument to function `ggplot()`. In the second argument, we map the variable 'value' onto the x-axis with the aesthetics argument `aes()`. `geom_histogram()` specifies the geometry of the plot and `theme_bw()` is used to add a [background theme](https://ggplot2.tidyverse.org/reference/ggtheme.html){target="_blank"}.

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.height = 4}

#filter NO2 measurements with temporal resolution 30min (HMW)
airquality %>%
  dplyr::filter(component == "NO2" & meantype == "HMW") %>%

  #create plot  
  ggplot2::ggplot(.,    #the dot '.' represents the piped value 
    aes(            
      x = value         #map variable 'value' onto x-axis
    )
  ) +
  ggplot2::geom_histogram() +    #define geometry
  ggplot2::theme_bw()            #define theme

```

If we aim to distinguish between measurements of respective measurement stations, we can map the variable 'station' onto visual variable color:

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.height = 4}

airquality %>%
  dplyr::filter(component == "NO2" & meantype == "HMW") %>%
  dplyr::filter(station == "S125" | station == "S431" | station == "S270") %>%    #select 3 stations

  ggplot2::ggplot(.,    
    aes(            
      x = value, 
      fill = station
      
    )
  ) +
  
  ggplot2::xlab("NO2 [mg/m^3]") +
  ggplot2::ylab("Count") +
  scale_fill_manual(name = "Measurement stations", values = c("grey20", "grey50", "grey80")) +
  ggplot2::geom_histogram() +   
  ggplot2::theme_bw()            

```

This is implemented by adding an attribute `fill = station` to the aesthetics element (`aes()`). `ggplot2` offers a number of [functions](https://ggplot2.tidyverse.org/reference/aes_colour_fill_alpha.html){target="_blank"} to specify your own set of mappings from levels in the data to aesthetic values. In the example above the function `scale_fill_manual()` is used to map the three levels S125, S270 and S431 to the [predefined ggplot colors](http://sape.inf.usi.ch/quick-reference/ggplot2/colour){target="_blank"} grey20, grey50 and grey80. Instead of ggplot colors, you can also use [hex color codes](https://htmlcolorcodes.com/){target="_blank"}.

```{block2, type = 'rmdexercise'}

Note that plot components are [added](https://ggplot2.tidyverse.org/reference/gg-add.html){target="_blank"} by means of a plus '+' sign. It allows you to start simple, then get more and more complex.

So far we have added two axis labels. Create a new R-Script, download the [input data](data/AirQualityUpperAut.csv){target="_blank"}, recreate the histogram and add a title to the plot (see [documentation](https://ggplot2.tidyverse.org/reference/labs.html){target="_blank"}).    

<details closed>
<summary><ins>**See solution!**</ins></summary>
<p><i><font color="grey">

Insert title:  
    
ggplot2::ggtitle("Nitrogen dioxide concentration")
    
</font></i>
</p>
</details>                                                                           
                                                                           

  
```

## Boxplots

- `x` categorical variable
- `y` variable to plot
- `geom_boxplot`






## Jittered points

- `x` categorical variable
- `y` variable to plot
- `geom_jitter`





## Violin plot

- `x` categorical variable
- `y` variable to plot
- `geom_violin`




## Violin plot




## Lines

- `x` e.g., a temporal variable
- `y` variable to plot
- `geom_line`




## Lines





## Scatterplots

- `x` and `y` variable to plot
- `geom_point`





## Overlapping points

- `x` and `y` variable to plot
- `geom_count` counts overlapping points and maps the count to size




## Overlapping points



## Bin counts

- `x` and `y` variable to plot
- `geom_bin2d`


## Bin counts





## Summary

Data visualisation

- Grammar of graphics
- ggplot2

**Next**: Descriptive statistics

- stat.desc
- dplyr::across

