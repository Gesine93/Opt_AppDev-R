# Read and write data

In the exercise 'data manipulation' we have **read** data from a CSV file into our script. Similarly we can also **write** code outputs to file.   

```{block2, type = 'rmdtip'}

In this lesson you will learn to read and write plain-text and spatial vector file formats. Moreover, we will retrieve online data by means of a data API.

```

## Read and write tabular data

A series of formats are based on plain-text files.

For instance...

- comma-separated values files `.csv`
- semi-colon-separated values files `.csv`
- tab-separated values files `.tsv`
- other formats using custom delimiters
- fix-width files `.fwf`

The [`readr` library](https://readr.tidyverse.org/){target="_blank"} (also part of [Tidyverse](https://www.tidyverse.org/packages/#import){target="_blank"}) provides a series of functions that can be used to load from and save to such data formats. For instance, the `read_csv` function reads a comma delimited (CSV) file from the path provided as the first argument. 

The code example below reads a CSV file that contains global fishery statistics provided by the [World Bank](https://datacatalog.worldbank.org/dataset/world-development-indicators){target="_blank"} and queries Norwegian entries. The function `writes_csv`  writes these entries to a new CSV file.  

```{r, echo=TRUE, message=FALSE, warning = FALSE}

library(tidyverse)

fishery_data <- readr::read_csv("data/capture-fisheries-vs-aquaculture.csv")
#print(fishery_data)

#print(typeof(fishery_data$))

fishery_data %>%
  dplyr::filter(Entity == "Norway") %>%
  readr::write_csv("data/capture-fisheries-vs-aquaculture-noraway.csv", append=FALSE) %>%
  
  dplyr::slice_head(n = 3) %>%
  knitr::kable()
  
```

In order to run the script, [download the CSV file](data/capture-fisheries-vs-aquaculture.csv){target="_blank"}. Then copy and run the code in a new R-script.

```{block2, type = 'rmdtip'}
Other important packages for reading tabular data are [readxl](https://readxl.tidyverse.org/){target="_blank"} for Excel (.xls and .xlsx) and [haven](https://haven.tidyverse.org/){target="_blank"} for SPSS, Stata and SAS data.  
```

## Read and write vector data

The library `sf` makes it easy to read and write vector datasets such as shapefiles. The name (sf stands for **simple features**) already implies that `sf` supports simple feature access via R.

Simple features is a widely supported data model that underlies data structures in many GIS applications including QGIS and PostGIS. A major advantage of this is that using the data model ensures your work is cross-transferable to other set-ups, for example importing from and exporting to spatial databases.

In order to load vector data in an R-Script, we can use the function `st_read()`. In the code block below, a shapefile ([North Carolina sample data](https://r-spatial.github.io/sf/reference/nc.html){target="_blank"}) is loaded and assigned to a variable nc. 

The next line creates a basic map in `sf` by means of `plot()`. By default this creates a multi-panel plot, one sub-plot for each variable of the object. 

```{r, echo=TRUE, message=FALSE, warning = FALSE}

library(sf)

nc <- sf::st_read("data/nc.shp")

plot(nc)

```

The library `sf` represents features as records in a data frame or tibble with a geometry list-column. The example below renders three features (rows) of variable nc including the geometry column as well as the attributes `AREA` (feature area) and `NAME` (name of county):  

```{r, echo=TRUE, message=FALSE, warning = FALSE}

nc %>%
  dplyr::select(AREA, NAME, geometry) %>%
  dplyr::slice_head(n = 3) %>%
  knitr::kable()

```

`sf` also includes a number of operations to manipulate the geometry of features such as `st_simplify`:  

```{r, echo=TRUE, message=FALSE, warning = FALSE}

sf::st_simplify(nc) %>%
  plot(., max.plot = 1)

```

```{block2, type = 'rmdtip'}

You may have recognized that a dot (.) is used as a parameter in the function `plot()`. The dot represents the piped value. In the example above the dot is used to define the simplified geometry of nc as first parameter of function `plot()` and `max.plot = 1` as the second.  

```

In the next example, the `st_geometry()` retrieves the geometry attribute from variable nc, function `st_centroid()` calculates the controid of the polygon geometry (counties) and function `st_write` writes the centroid point geometry to file. 

```{r, echo=TRUE, message=FALSE, warning = FALSE}

sf::st_geometry(nc) %>%
  sf::st_centroid() %>%
  sf::st_write("data/nc-centroids.shp", delete_dsn = TRUE) %>%
  plot(pch = 3, col = 'red') 
  
```

```{block2, type = 'rmdtip'}
The online book [Geocomputation with R](https://geocompr.robinlovelace.net/geometric-operations.html){target="_blank"} offers a more comprehensive explanation of available geometric, attribute and spatial data operations. For a quick overview you may turn to the [sf cheatsheets](https://github.com/rstudio/cheatsheets/blob/master/sf.pdf){target="_blank"}. 
```

In order to test the code on your machine, [download](data/nc-centroids.shp){target="_blank"} the North Carolina dataset and install the libraries `sf` and `Rcpp` before you run the code in an R-Script.   

```{block2, type = 'rmdexercise'}

The `plot()` function offers a large number of arguments that can be used to customize your map. Replace 'Area' in the map above by a more meaningful map title. Turn to the [documentation](https://r-spatial.github.io/sf/reference/plot.html){target="_blank"} for more information.    

See [my solution](Solution_Miniexercise_plot.R){target="_blank"}!

```

Similar R functions are also available for raster data (see package [raster: Geographic Data Analysis and Modeling](https://cran.r-project.org/web/packages/raster/raster.pdf){target="_blank"}) 

## Data API

tidyverse library httr?


```{block2, type = 'rmdtip'}

[Tidyverse](https://www.tidyverse.org/packages/){target="_blank"} also provides other packages for reading data such as [DBI](https://cran.r-project.org/web/packages/DBI/){target="_blank"} for relational databases [jsonlite](https://cran.r-project.org/web/packages/jsonlite/){target="_blank"} for JSON and [xml2](https://cran.r-project.org/web/packages/xml2/){target="_blank"} for XML. 

```


