---
title: "Comparison: httr2 vs httr"
date: "`r Sys.Date()`"
output: html_document
---

## Introduction

In this document, I will compare the functionalities of `httr2` and `httr` packages for making HTTP requests in R.

## Using httr2

```{r}
# Load the httr2 library
library(httr2)

# Define the base URL and parameters
base <- "http://api.openweathermap.org/data/2.5/weather"
lat <- "47.81"    
lon <- "13.03"
apiKey <- "3f87141421b32590d50416aae5ca780c"

# Construct the full URL with query parameters
full_url <- sprintf("%s?lat=%s&lon=%s&appid=%s", base, lat, lon, apiKey)

# Print the constructed URL
print(full_url)

# Create the request
req <- request(full_url)

# Perform the request and store the response
resp <- req_perform(req)

# Check the status code of the response
print(resp_status(resp))

# View the content structure of the response in JSON
str(resp_body_json(resp))

# Convert the response content directly to a data frame
response_df <- as.data.frame(resp_body_json(resp))

# Additional methods and functionalities with httr2
```

## Using httr
```{r}
library(httr)

base <- "http://api.openweathermap.org/data/2.5/weather"
lat <- "47.81"    
lon <- "13.03"
apiKey <- "3f87141421b32590d50416aae5ca780c"

call <- paste(base, "?lat=", lat, "&lon=" , lon, "&appid=", apiKey, sep="")

print(call)
get <- GET(call) # response object
status_code(get) # status code
str(content(get)) # gives content information

library(jsonlite)

get_text <- content(get, "text")                 #retrieve contents of request as character vector (library httr)
get_json <- fromJSON(get_text, flatten = TRUE)   #convert from JSON to R Object (library jsonlite)
get_df <- as.data.frame(get_json)                #convert R Object to Data Frame
```

... Now this seems more elaborate in the beginning, but it increases the workflow by a mile, it now creates objects and uses pipe operator withoug magrittr for example

Other methods you can easily do with httr2:

```{r}
# build a request object
req <- request(full_url)
req # shows you the whole url + body information

# now with the req_ functions, we can use different approaches we might want from the request
# we can now use the pipe operator easily without using magrittr!
# Add custom headers
req %>% req_headers("Accept" = "application/json")
# <httr2_request>
# GET http://api.openweathermap.org/data/2.5/weather?lat=47.81&lon=13.03&appid=3f87141421b32590d50416aae5ca780c
# Headers:
#   • Accept: 'application/json'
# Body: empty

# Add a body, turning it into a POST
req %>% req_body_json(list(x = 1, y = 2))
# <httr2_request>
#  POST http://api.openweathermap.org/data/2.5/weather?lat=47.81&lon=13.03&appid=3f87141421b32590d50416aae5ca780c
# Body: json encoded data

# Automatically retry if the request fails
req %>% req_retry(max_tries = 2)

# GET http://api.openweathermap.org/data/2.5/weather?lat=47.81&lon=13.03&appid=3f87141421b32590d50416aae5ca780c
# Body: empty
# Policies:
#  • retry_max_tries: 2

# Change the HTTP method
req %>% req_method("PATCH")
#> <httr2_request>
#> PATCH http://api.openweathermap.org/data/2.5/weather?lat=47.81&lon=13.03&appid=3f87141421b32590d50416aae5ca78
#> Body: empty

#And see exactly what httr2 will send to the server with req_dry_run():
req %>% req_dry_run()

#> GET /data/2.5/weather?lat=47.81&lon=13.03&appid=3f87141421b32590d50416aae5ca780c HTTP/1.1
#> Host: api.openweathermap.org
#> User-Agent: httr2/0.2.3 r-curl/5.0.2 libcurl/7.84.0
#> Accept: */*
#> Accept-Encoding: deflate, gzip

#Use req_perform() to perform the request, retrieving a response:
resp <- req_perform(req)
resp
#> <httr2_response>
#> GET http://api.openweathermap.org/data/2.5/weather?lat=47.81&lon=13.03&appid=3f87141421b32590d50416aae5ca780c
#> Status: 200 OK
#> Content-Type: application/json
#> Body: In memory (467 bytes)

#The resp_ functions help you extract various useful components of the response in detail:
resp %>% resp_content_type()
#> [1] "application/json"
resp %>% resp_status_desc()
#> [1] "OK"

#> Calls and shows us the complete response and all its attributes!
resp %>% resp_body_json()
```
## Conclusion

### Request Creation and Execution:

httr2 introduces a more modular approach, allowing for a two-step process in creating and performing requests. This offers more flexibility and control over the request process, especially when constructing complex requests.
httr, on the other hand, provides a more direct and straightforward approach, which might be preferred in simpler use cases.
Pipe Operator:

With httr2, there's the advantage of using the pipe operator without needing the magrittr package. This can simplify the code and make it more readable.

### Response Handling:

httr2 offers functions like resp_body_json() to directly extract JSON content from the response, whereas httr requires the use of the content() function followed by additional processing.
Flexibility:

The httr2 package provides a range of functions (req_ functions) that allow for more granular modifications to the request object, such as adding headers, changing the HTTP method, or setting retry policies. This can be particularly useful when dealing with more complex API endpoints or when more control over the request is required.

## References

- [httr2 documentation](https://httr2.r-lib.org/)
- [httr documentation](https://httr.r-lib.org/)
