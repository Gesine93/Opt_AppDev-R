# R Markdown

This lesson is dedicated to the library `rmarkdown`. In fact, however, R Markdown is more than only a library. [RMarkdown](https://rmarkdown.rstudio.com/){target="_blank"} belongs to a set of tools that are designed to improve the reproducibility of your work. Other tools and platforms such as [GitHub](https://github.com/){target="_blank"}, [Jupyter](https://jupyter.org/){target="_blank"}, [Docker](https://www.docker.com/){target="_blank"} or preprint servers such as [ArXiv](https://arxiv.org/){target="_blank"} or [bioRxiv](https://www.biorxiv.org/){target="_blank"} facilitate reproducibility in many different ways. In this module, we will not cover the paradigm of [reproducible research](https://esajournals.onlinelibrary.wiley.com/doi/full/10.1002/bes2.1801){target="_blank"} in detail. Instead, we will focus on those aspects that will helping you make your analyses and reports more appealing, interactive and efficient.

```{block2, type = 'rmdtip'}

In this lesson, we will weave together code and text in professionally rendered R Markdown documents. And we will use [GitHub](https://github.com/){target="_blank"} to safely store, share and administer our results.    

```

## Set up your work environment

Before you will create your first R Markdown document, we have to setup the GitHub environment. GitHub was originally founded as a platform for software developers. The architecture of GitHub is designed to manage changes that are made to computer software in the process of software development. The same architecture, however, can also be used to control the versioning of documents or any other collection of information.

Version control is particularly important when working in teams to sync working steps among project participants. However, even when working individually, GitHub is a trustworthy and open online data dump that tracks changes and simplifies the documentation and sharing of your work and others.

```{block2, type = 'rmdexercise'}

To setup your personal GitHub environment, follow these steps:

1) Read through the [Hello-World-Section](https://docs.github.com/en/get-started/quickstart/hello-world){target="_blank"} of GitHub's Quickstart Documentation. For now, reading is fine. You do not necessarily have to work through the tutorial.  
2) [Create a GitHub account](https://github.com/){target="_blank"}.
3) [Download and install Git](https://git-scm.com/downloads){target="_blank"}. [Git](https://docs.github.com/en/get-started/quickstart/set-up-git){target="_blank"} it is a distributed VCS (version control system), in which the codebase aswell as it's full history is mirrored on every computer. GitHub therefore, is a web-based interface that uses Git very well. If you are interested in its theory and practice, this [video](https://www.youtube.com/watch?v=uR6G2v_WsRA){target="_blank"} gives a very nice explanation of core concepts in Git.
4) Open R Studio -> Tools -> Global Options -> Git / SVN: check "enable version control" and set the path to the git.exe (e.g. C:/Program Files/Git/bin/git.exe). Restart RStudio.
5) [Create a repository](https://docs.github.com/en/get-started/quickstart/create-a-repo){target="_blank"} on GitHub. In the tutorial,  Skip section 'Commit your first changes'. 
6) By default, your repository has one branch named `main`. Create an additional branch off the `main` and call this new branch `dev`. To do so, follow the instructions in the [Hello-World-Tutorial](https://docs.github.com/en/get-started/quickstart/hello-world){target="_blank"}.

```

As next step, you will have to install the `rmarkdown` library as well as `tinytex` in RStudio as described in the [R Markdown Guide](https://bookdown.org/yihui/rmarkdown/installation.html){target="_blank"}.

```{block2, type = 'rmdtip'}

In order to correctly install `tinytex`, make sure to execute both lines in RStudio:
  
```

```{r, echo=TRUE, eval = FALSE}
install.packages('tinytex')
tinytex::install_tinytex()  # install TinyTeX
```

RStudio may call for the installation of dependencies. Follow the instructions and install the requested libraries. In case you are facing any technical issues, please turn to the discussion forum!

## Create a local clone

In order to locally work on your repository contents, you will have to create a local clone of your online GitHub repository.

```{block2, type = 'rmdexercise'}

In RStudio: File -> New Project... -> Version Control -> Git.

Copy/past the Repository URL (go to your Online repository to find URL), browse local directory and `Create Project` (see Fig. \@ref(fig:L09-clone)).

```

```{r L09-clone, echo=FALSE, fig.cap="Clone GitHub Repository", out.width='70%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/Gitclone.png')
```

Once you have cloned the online repository, the file contents of the repository as well as a new tab called `Git` appears in RStudio (see Fig. \@ref(fig:L09-features)).

```{r L09-features, echo=FALSE, fig.cap="New features in RStudio", out.width='80%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/NewFeatures.png')
```

Per default the repository contains three files:

1)  [`gitignore`](https://git-scm.com/docs/gitignore){target="_blank"}
2)  An [RStudio Project File](https://support.rstudio.com/hc/en-us/articles/200526207-Using-RStudio-Projects){target="_blank"} (.Rproj)
3)  A [ReadMe File](https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-readmes){target="_blank"} (.md = pure markdown)

[`gitignore`](https://git-scm.com/docs/gitignore){target="_blank"} and the [RStudio Project File](https://support.rstudio.com/hc/en-us/articles/200526207-Using-RStudio-Projects){target="_blank"} were created on project initialization, meaning that these files are new and not yet available in the online repository. Changes made to the original repository are listed in the `Git tab` (see Fig. \@ref(fig:L09-changes)).

```{r L09-changes, echo=FALSE, fig.cap="Changes in Git tab", out.width='80%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/Changes.png')
```

Before we further modify our repository, switch to the `dev` branch (see Fig. \@ref(fig:L09-branch)). At the moment `dev` branch and `main` branch are identical.

```{r L09-branch, echo=FALSE, fig.cap="Switch branch", out.width='80%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/Branches.png')
```

```{block2, type = 'rmdtip'}

It his highly recommended to keep work in progress separate from the `main` branch by working in a separate developer branch. Later, branches may be unified by merging from `dev` into the `main` branch (see [Opening a pull request](https://docs.github.com/en/get-started/quickstart/hello-world#opening-a-pull-request){target="_blank"}).

```

## Create a first RMarkdown document

Now that the environment is set up, we can create a first simple R Markdown document.

```{block2, type = 'rmdexercise'}

In RStudio: File -> New File -> R Markdown....

Type in a title, keep the default settings and confirm with `OK`. As a result you get a minimal R Markdown sample file, with the file extension `.Rmd`.

```

As apparent from the sample file, R Markdown documents are composed of the three basic components **metadata**, **text** and **code** (see Fig. \@ref(fig:L09-sample)).

```{r L09-sample, echo=FALSE, fig.cap="R Markdown sample file", out.width='80%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/SampleFile.png')
```

The syntax for the metadata is [YAML](https://en.wikipedia.org/wiki/YAML){target="_blank"}. In our document, the metadata section specifies the title of the document, the output format, and the date of creation. Many other document properties can be specified in this section. [Here](https://cran.r-project.org/web/packages/ymlthis/vignettes/yaml-overview.html){target="_blank"} you can find an overview of the basic YAML syntax.

Though, as an addition, you can also update the date automatically reflected on the last update of your report. In the metadata section you put in this simple code: r format(Sys.time(), '%d %B, %Y') it will output you the date of your systems current time zone in a human-readable way.

After the metadata section an **R inline code block** starts and ends with backticks. The three **parameters** in curly brackets identify the code as R code.The `r` gives you the specific programming language, which is the default for R. But for example, you can also use {py} for Python (see Fig. \@ref(fig:L09-python)). Try the command: names(knitr::knit_engines\$get()) to get a list of the supported programming languages. `setup` is the name of the code block (also called code chunk) and (as we will see later) `include=FALSE` prevents code and code results of this code chunk from being displayed in the compiled HTML output. Nevertheless, R Markdown still runs the code in this block. The inline code block as such sets `echo=TRUE` as default option for all code chunks in the document. This means, per default the code of all code chunks in the document are displayed in the output file, if not otherwise indicated.

```{r L09-python, echo=FALSE, fig.cap="Python Example", out.width='90%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/pyexample.png')
```

The other code blocks in the `.Rmd` document produce a summary output (see lines 7-19) or create a simple scatterplot (see lines 25-27). To see how the compiled HTML output looks like, click `Knit` (see Fig. \@ref(fig:L09-knit)).

```{r L09-knit, echo=FALSE, fig.cap="Knit HTML Output ", out.width='80%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/knit.png')
```

Alternatively, you may click on the dropdown arrow next to the `Knit` button and compile `PDF` or `.docx` outputs. Though, there are even [more](https://rmarkdown.rstudio.com/lesson-9.html){target="_blank"} supported formats.

```{block2, type = 'rmdexercise'}

Please take your time to understand how the `.Rmd` syntax translates into an output. For instances, to bold text, you can add two asterisks before and after a word or phrase.  

```

## Synchronize with GitHub

It is good practice to synchronize changes made to the project on a regular basis with the online repository. First, we need to pull changes that someone else could have made in the meantime.

```{block2, type = 'rmdexercise'}

Click the `Pull button` in the `Git tab` (see Fig. \@ref(fig:L09-pull)). A message appears indicating that no other changes have been made (`Already up to date`).

```

```{r L09-pull, echo=FALSE, fig.cap="Make Pull", out.width='80%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/pull.png')
```

Even if you work on your own, it is advisable to routinely start the sync process with a `Pull`.

Before you can push your own changes to the online repository, you have to `Commit` changes. Committing is like in-process saving. The `Commit` takes a snapshot of your changes. This snapshot is combined with a user defined commit message.

```{block2, type = 'rmdexercise'}

Locally save all documents in RStudio. Click the `Commit button` in the `Git tab` . Those files that are affected by changes are listed in the commit window. You can click on one of the files. The changes will be displayed (green is new, red is deleted content).

Manually select all files by clicking the respective checkboxes. In order to make sure that you have not missed a file, you may execute `git add -A` in the terminal window to add all files to the commit (see [list of popular Git Commands](https://github.com/joshnh/Git-Commands){target="_blank"}). Once this is done, enter a meaningful commit message that describes your revision and push the `Commit button`. 

See Fig. \@ref(fig:L09-commit)

```

```{r L09-commit, echo=FALSE, fig.cap="Make Commit", out.width='70%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/commit.png')
```

To finish the sync process, click the `Push button` in the `Git tab` (see Fig. \@ref(fig:L09-push)).

```{r L09-push, echo=FALSE, fig.cap="Make Push", out.width='70%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/Push.png')
```

Your online repository on GitHub should now be updated (switch to `dev` branch in your repository) (see Fig. \@ref(fig:L09-updated)).

```{r L09-updated, echo=FALSE, fig.cap="Commit with message 'decribe sync process in github' was pushed to the developer branch a minute ago", out.width='90%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/CommitFinished.png')
```

## Basic R Markdown syntax

The use of double asterisks (`**Text**`) to bold words and phrases in R Markdown documents has already been mentioned. Alternatively, text may be italicized by placing single asterisks (`*Text*`) before and after text.

Moreover, hash signs indicate headings. The number of hash signs you use corresponds to the heading level (limited up to 6.):


    # Heading level 1

    ## Heading level 2

    ### Heading level 3


Do you remember in the first chapter, the numeric operators table? 
Tables are made by using the symbol | and - like this:

```{r L09-tables, echo=FALSE, tab.cap="How Tables are made in Markdown", out.width='100%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/tables.png')
```

Now you might ask yourself if we want to use a \# hash sign, or a double underscore \_italic_. But not for a heading or italic style, but in our sentence. How can we tell Markdown to ignore these special characters? This works with an \\ backslash. Simply, put the backslash before your special character. The backslash sign then gets ignored and you will see the specific sign. 

R Markdown also comes with a time-saving method to insert **citations** and to build a **bibliography**. References are collected in a .bib-file that resides in the RStudio Project folder. To create a .bib-file, you can use any text editor. Open a new document (for instance a Windows Editor file), replace .txt with .bib (e.g. references.bib) and save to the Project folder.

```{block2, type = 'rmdtip'}

You can use the RStudio project that you have cloned, modified and synchronized in previous exercises.

```

Now you can add references to the .bib-file. References are encoded in BibTeX format. The easiest way to get the BibTeX description of a reference is to export from Google Scholar. To enable BibTeX export, change setting in Google Scholar (see Fig. \@ref(fig:L09-scholarsettings)).

```{r L09-scholarsettings, echo=FALSE, fig.cap="Enable BibTeX in Firefox 106.0.1", out.width='90%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/ScholarSettings.png')
```

```{block2, type = 'rmdtip'}
You may use a different browser or version of Firefox. In case you need support, please turn to the discussion forum!
```

Once you have enabled BibTeX export in your browser, a new link `Import into BibTeX` appears in Google Scholar (see Fig. \@ref(fig:L09-biboption)).

```{r L09-biboption, echo=FALSE, fig.cap="BibTeX Link in Firefox 106.0.1", out.width='90%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/bibtexoption.png')
```

Click the link and copy & paste the BibTeX code into your .bib-file.

Now you can use the reference in your R Markdown file by specifying the name of the .bib-file as YAML metadata. You can add multiple BibTeX references to the .bib-file. The syntax to embedded references in text is `@<first BibTeX parameter` (see Fig. \@ref(fig:L09-refs)).

```{r L09-refs, echo=FALSE, fig.cap="Integrate BibTeX reference in RMarkdown document", out.width='90%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/refs.png')
```

To compile your R Markdown document, `knit` as HTML, PDF or Word. The `rmarkdown` library renders references as indirect citations (*reference without squared brackets in .Rmd file*) and direct citations (*reference with squared brackets in .Rmd file*) and inserts a bibliography (see Fig. \@ref(fig:L09-pdfknit)).

```{r L09-pdfknit, echo=FALSE, fig.cap="Knit R Markdown as PDF", out.width='90%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/knit_pdf.png')
```

[Here](%22data/ReferencesInRMarkdown.zip%22){target="_blank"} you can find a worked example for download. Unzip the folder and open the .Rproj file in RStudio.

```{block2, type = 'rmdtip'}
Other helpful R Markdown syntax examples can be looked up in the [RMarkdown Cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf){target="_blank"}.
```

## Speed up your workflows

Many of the methods that were covered in this module are intended to make repetitive workflows more efficient and less time-consuming. In this section, an example is introduced that illustrates the great potentials of R Markdown in terms of automation and efficiency improvement.

Let's assume a client of you is interest in a specific set of spatial economic indicators that are updated daily. Rather than creating a data report on every new day from scratch, R Markdown allows you to create a data report with charts that are auto-generated on report compilation.

Data can be retrieved in real-time by means of [Alpha Ventage](https://www.alphavantage.co/){target="_blank"}. Alpha Ventage provides financial market data through the [Alpha Ventage Rest API](https://www.alphavantage.co/documentation/){target="_blank"}. To access the API in R, we can use the R library [`alphaventager`](https://cran.r-project.org/web/packages/alphavantager/index.html){target="_blank"}.

```{block2, type = 'rmdexercise'}

In this exercise you are provided with a first draft version of the finance data report. [Download](data/RMarkdownFinanceData.zip){target="_blank"} the draft version. Unzip the folder and open the .Rproj file in RStudio. 

The project includes a .bib file that contains a BibTeX reference, a .csv file (see folder data) with more than 400 country names, national currencies and currency codes and an .Rmd file with inline R code that renders real-time currency exchange in a map.

Carefully read through the .Rmd file **before you compile an HTML output**.

Important: The .Rmd file includes an interactive leaflet map, i.e. other outputs than HTML are not supported.

Once you have understood the structure of this document, try to supplement the finance data report with an additional spatial indicator (e.g. map of exchange rates from national currencies to Euro).

```


## Self-study

The functionality of R Markdown is comprehensive and cannot be covered in one lesson. It is highly recommended to consult the online book [R Markdown: The Definitive Guide](https://bookdown.org/yihui/rmarkdown/){target="_blank"} to leverage the full potential of R Markdown.

Other R Markdown compile formats that are described in this book are Notebooks and Presentations. RMarkdown also support other languages such as Python, C++ and SQL. Moreover, R Markdown is customizable and can be used to design more complex documents with extensions like [BookDown](https://bookdown.org/){target="_blank"} or [ThesisDown](https://github.com/ismayc/thesisdown){target="_blank"}.

```{block2, type = 'rmdtip'}
By the way, this module is written in BookDown.
```



