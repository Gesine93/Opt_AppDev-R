# R Markdown

This lesson is dedicated to the `rmarkdown` library. However, R Markdown is **more than just a library.** [RMarkdown](https://rmarkdown.rstudio.com/){target="_blank"}  is part of a set of tools designed to enhance the reproducibility of your work. Other tools and platforms such as [GitHub](https://github.com/){target="_blank"}, [Jupyter](https://jupyter.org/){target="_blank"}, [Docker](https://www.docker.com/){target="_blank"}, [ArXiv](https://arxiv.org/){target="_blank"}, and [bioRxiv](https://www.biorxiv.org/){target="_blank"} facilitate reproducibility in various ways. In this module, we won't cover the paradigm of [reproducible research](https://esajournals.onlinelibrary.wiley.com/doi/full/10.1002/bes2.1801){target="_blank"} in detail. Instead, our focus will be on how to use RMarkdown to make your analyses and reports more appealing, interactive, and **efficient**.

```{block2, type = 'rmdtip'}

In this lesson, we will weave together code and text in professionally rendered R Markdown documents and use [GitHub](https://github.com/){target="_blank"} to safely store, share, and administer our results.    

```

## Set up your work environment

Before creating your first R Markdown document, we need to **set up** the **GitHub** environment. Originally founded as a platform for software developers, GitHub's architecture is designed to manage changes made during software development. This architecture is also beneficial for version control of documents or any information collection.

Version control is especially important when working in teams, as it helps synchronize efforts among project participants. However, GitHub is also a reliable and open online platform for individual work, providing change tracking, documentation, and sharing features.

```{block2, type = 'rmdexercise'}
To set up your personal GitHub environment, follow these steps:

1) Review the [Hello-World Section](https://docs.github.com/en/get-started/quickstart/hello-world){target="_blank"} in GitHub's Quickstart Documentation. Initially, reading it is sufficientâ€”no need to complete the tutorial yet.
2) [Create a GitHub account](https://github.com/){target="_blank"}.
3) [Download and install Git](https://git-scm.com/downloads){target="_blank"}. Git is a distributed **VCS (version control system)** that mirrors the codebase and its full history on every computer. GitHub is a web-based interface that integrates seamlessly with Git. For a clear explanation of Git's core concepts, watch this [video](https://www.youtube.com/watch?v=uR6G2v_WsRA){target="_blank"}.
4) In RStudio (under Tools > Global Options > Git / SVN), check "enable version control" and set the path to git.exe (e.g., C:/Program Files/Git/bin/git.exe). Restart RStudio afterward.
5) [Create a repository](https://docs.github.com/en/get-started/quickstart/create-a-repo){target="_blank"} on GitHub. In the tutorial, skip the section 'Commit your first changes'.
6) By default, your repository will have one branch named `main`. Create an additional branch called `dev` off the `main`. Follow the instructions in the [Hello-World Tutorial](https://docs.github.com/en/get-started/quickstart/hello-world){target="_blank"} for guidance.
```


Next, install the `rmarkdown` library and `tinytex` in RStudio as described in the [R Markdown Guide](https://bookdown.org/yihui/rmarkdown/installation.html){target="_blank"}.


```{block2, type = 'rmdtip'}

To properly **install**`tinytex`, execute both lines in RStudio:

```

```{r, echo=TRUE, eval = FALSE}
install.packages('tinytex')
tinytex::install_tinytex()  # install TinyTeX
```

Follow RStudio's prompts to install any dependencies. For technical issues, please consult the discussion forum.

## Create a local clone

To work on your repository locally, you will need to create a local clone of your online GitHub repository. Here's how:

```{block2, type = 'rmdexercise'}

In RStudio, go to (File > New Project > Version Control > Git).

Enter the URL of your online repository (find this URL in your GitHub repository) and select a local directory for the clone. Then click `Create Project` (refer to Fig. \@ref(fig:L09-clone)).


```

```{r L09-clone, echo=FALSE, fig.cap="Clone GitHub Repository", out.width='70%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/Gitclone.png')
```

Once you have cloned the online repository, the file contents of the repository as well as a new tab called `Git` appears in RStudio (see Fig. \@ref(fig:L09-features)).

```{r L09-features, echo=FALSE, fig.cap="New features in RStudio", out.width='80%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/NewFeatures.png')
```

By default, the repository includes three files:

1) [`.gitignore`](https://git-scm.com/docs/gitignore){target="_blank"}: Specifies intentionally untracked files to ignore.
2) [RStudio Project File](https://support.rstudio.com/hc/en-us/articles/200526207-Using-RStudio-Projects){target="_blank"} (`.Rproj`): Contains metadata for the RStudio project.
3) [ReadMe File](https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-readmes){target="_blank"} (`.md`): A markdown file with information about the repository.

The [`gitignore`](https://git-scm.com/docs/gitignore){target="_blank"} and [`.Rproj`](https://support.rstudio.com/hc/en-us/articles/200526207-Using-RStudio-Projects){target="_blank"} files are created during project initialization and are not yet in the online repository. Modifications appear in the `Git` tab (Fig. \@ref(fig:L09-changes)).

```{r L09-changes, echo=FALSE, fig.cap="Changes in Git tab", out.width='80%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/Changes.png')
```

Before making further changes, switch to the `dev` branch (see Fig. \@ref(fig:L09-branch)). Currently, the `dev` branch is identical to the `main` branch.

```{r L09-branch, echo=FALSE, fig.cap="Switch branch", out.width='80%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/Branches.png')
```

```{block2, type = 'rmdtip'}

It is **highly recommended** to work in progress on a separate developer branch, like `dev`, and keep the `main` branch for stable versions. You can later merge changes from `dev` to `main` through a pull request (see [Opening a Pull Request](https://docs.github.com/en/get-started/quickstart/hello-world#opening-a-pull-request){target="_blank"}).

```

## Creating Your First R Markdown Documen

Now that the environment is set up, let's create our first R Markdown document.

```{block2, type = 'rmdexercise'}

In RStudio: (File > New File > R Markdown):

Type in a title, keep the default settings and confirm with `OK`. As a result you get a minimal R Markdown sample file, with the file extension `.Rmd`.

```

As apparent from the sample file, R Markdown documents are composed of the three basic components **metadata**, **text** and **code** (see Fig. \@ref(fig:L09-sample)).

```{r L09-sample, echo=FALSE, fig.cap="R Markdown sample file", out.width='80%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/SampleFile.png')
```

The syntax for the metadata is [YAML](https://en.wikipedia.org/wiki/YAML){target="_blank"}. In our document, the metadata section specifies the title of the document, the output format, and the date of creation. Many other document properties can be specified in this section. [Here](https://cran.r-project.org/web/packages/ymlthis/vignettes/yaml-overview.html){target="_blank"} you can find an **overview** of the basic YAML syntax.

```{block2, type = 'rmdtip'}

You can also update the date automatically to reflect the last time the report was updated by adding this line to the metadata section: `date: "```r format(Sys.time(), '%d %B, %Y')```"`. This will output the current date in a human-readable format based on your systems time zone.

```

After the metadata section an **R inline code block** starts and ends with three backticks (see Fig. \@ref(fig:L09-sample)). The three **parameters** in curly brackets identify the code as R code. The `r` specifies the programming language, which is the default for R. Alternatively, you can also use parameter `{py}` to insert Python code into your markdown document (see Fig. \@ref(fig:L09-python)).

```{r L09-python, echo=FALSE, fig.cap="Python Example", out.width='90%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/pyexample.png')
```

The `setup` parameter specifies the name of the code block and (as we will see later) `include=FALSE` prevents the code and code results from being displayed in the compiled HTML output. Nevertheless, RMarkdown still runs the code in this block, which sets `echo=TRUE` as the default option for all code blocks in the RMarkdown document. This means that, by default, the code of all code blocks in the document will be displayed in the output file unless otherwise indicated. 

```{block2, type = 'rmdtip'}
To learn more about code block options you may turn to the [knitr documentation](https://yihui.org/knitr/options/){target="_blank"}.
```

The other code blocks in the RMarkdown sample file produce a summary output (see line 17-19) or create a simple scatterplot (see line 25-27). To see how the compiled HTML output looks like, click `Knit` (see Fig. \@ref(fig:L09-knit)).

```{r L09-knit, echo=FALSE, fig.cap="Knit HTML Output ", out.width='80%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/knit.png')
```

You can also use the dropdown arrow next to the **Knit** button to compile `PDF` or `.docx` outputs, or choose from the [other](https://rmarkdown.rstudio.com/lesson-9.html){target="_blank"} supported formats.

```{block2, type = 'rmdexercise'}

When you **"knit"** an R Markdown document, the `.Rmd` file is processed by the knitr package, which executes the code chunks and creates a new markdown file containing the code and its output. This markdown file is then processed by pandoc, which creates the final output document in the specified format. This two-step process allows for a wide range of output options and enables you to easily create professional-quality documents from your R Markdown code.

```

## Synchronize with GitHub

It's good practice to **synchronize** changes made to the project **regularly** with the online repository. First, you need to pull any changes that someone else may have made.

```{block2, type = 'rmdexercise'}

Click the `Pull button` in the `Git tab` (see Fig. \@ref(fig:L09-pull)). A message appears indicating that no other changes have been made (`Already up to date`).

```

```{r L09-pull, echo=FALSE, fig.cap="Make Pull", out.width='80%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/pull.png')
```

Even if you're working on your own, it's a good idea to routinely start the sync process with a `Pull`.

Before you can push your own changes to the online repository, you have to `Commit` changes. Committing is like in-process saving. The `Commit` takes a snapshot of your changes and combines it with a user-defined commit message.

```{block2, type = 'rmdexercise'}

Save all documents in R Studio, then click the `Commit` button in the Git tab. The files that have been affected by changes will be listed in the commit window. You can click on one of the files to see the changes (green represents new content, red represents deleted content).

Manually select all the files by clicking the corresponding checkboxes. To make sure you have not missed a file, you may execute `git add -A` in the terminal window to add all files to the commit (see [this](https://github.com/joshnh/Git-Commands){target="_blank"} list of popular Git Commands.) Once this is done, enter a meaningful commit message that describes your revision and click the `Commit button`. 

See Fig. \@ref(fig:L09-commit)

```

```{r L09-commit, echo=FALSE, fig.cap="Make Commit", out.width='70%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/commit.png')
```
&nbsp;

To finish the sync process, click the `Push button` in the `Git tab` (see Fig. \@ref(fig:L09-push)).


```{r L09-push, echo=FALSE, fig.cap="Make Push", out.width='70%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/Push.png')
```
&nbsp;

Your online repository on GitHub should now be updated (switch to `dev` branch in your repository) (see Fig. \@ref(fig:L09-updated)).

```{r L09-updated, echo=FALSE, fig.cap="Commit with message 'describe sync process in github' was pushed to the developer branch a minute ago", out.width='90%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/CommitFinished.png')
```

## Basic RMarkdown syntax

In R Markdown documents, you can use double asterisks (`**Text**`) to **bold** words and phrases, or single asterisks (`*Text*`) to *italicize* them.

You can also create **headings** using hash signs (`#`). The number of hash signs you use corresponds to the heading level:


    # Heading level 1

    ## Heading level 2

    ### Heading level 3

**Tables** are created by using the symbols `|` and `-`. Do you remember in the first lesson, the [numeric operators table](#numop)? Figure \@ref(fig:L09-tables) illustrates the RMarkdown syntax being used to create this table. 

```{r L09-tables, echo=FALSE, fig.cap="How Tables are made in Markdown", out.width='100%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/tables.png')
```

To create an **ordered list**, use numbers followed by a period. The first item should start with the number `1`:
    
    Code - Ordered List:
    1. item 1
    4. item 2
    3. Item 3
        + Item 3a
        + Item 3b

**Will result in:**

1. Item 1
4. Item 2
3. Item 3
    + Item 3a
    + Item 3b


To create an **unordered list**, use `*`, `-`, or `+`:
    
    Code - Unordered List:
    * item 1
    * item 2
      * Item 3.1
      - Item 3.2

**Which will result in:**

* Item 1
* Item 2
    + Item 2a
    - Item 2b

The following syntax example illustrate how to create **hyperlinks** in RMarkdown documents:

`[Github](https://github.com/){target="_blank"}`

Result looks like this [Github](https://github.com/){target="_blank"} link.

By setting parameter `target="_blank`, the link is opened in a new browser tab.

**Blockquotes** are written after a greater-than sign **(`>`)** and can be indented by adding a second greater-than sign **(`>>`)** like... 

    >"Everything is related to everything else, but near things are more related than distant things".
    >
    >>The phenomenon external to an area of interest affects what goes on inside.

>The first law of geography is: "Everything is related to everything else, but near things are more related than distant things"
>
>>The phenomenon external to an area of interest affects what goes on inside.

```{block2, type = 'rmdtip'}

Meanwhile, you know a number of characters that have a special meaning in RMarkdown syntax (like `#` or `>`). If you want these characters verbatim, you have to escape them. The way to **escape a special character** is to add a backslash before. For instance, `#` will not translate into a heading, but will return `#`.

```

RMarkdown supports a large number of **mathematical notations**, which are surrounded by dollar signs `$`.   

**Math. notation example 1:**

`$x = y$`

Result looks like... $x = y$

**Math. notation example 2:**

`$\frac{\partial f}{\partial x}$`

Result looks like... $\frac{\partial f}{\partial x}$

See ["Mathematics in R Markdown"](https://rpruim.github.io/s341/S19/from-class/MathinRmd.html){target="_blank"} for more examples.

### References in RMarkdown

R Markdown also comes with a time-saving method to insert **citations** and to build a **bibliography**. References are collected in a `.bib-file`. 
Create a new document in a text editor such as Windows Editor. Save the file with a `.bib` extension (e.g. `references.bib`) in your RStudio project folder.

```{block2, type = 'rmdtip'}

You can use the RStudio project that you have cloned, modified and synchronized in previous exercises.

```

Now you can **add references** to the `.bib-file`. References are encoded in BibTeX format. The easiest way to get the BibTeX description of a reference is to export from Google Scholar. To enable BibTeX export, change setting in Google Scholar (see Fig. \@ref(fig:L09-scholarsettings)).

```{r L09-scholarsettings, echo=FALSE, fig.cap="Enable BibTeX in Firefox 106.0.1", out.width='90%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/ScholarSettings.png')
```

```{block2, type = 'rmdtip'}
You may use a different browser or version of Firefox. In case you need support, please turn to the discussion forum!
```

Once you have enabled BibTeX export in your browser, a new link `Import into BibTeX` appears in Google Scholar (see Fig. \@ref(fig:L09-biboption)).

```{r L09-biboption, echo=FALSE, fig.cap="BibTeX Link in Firefox 106.0.1", out.width='90%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/bibtexoption.png')
```

Click the link in Google Scholar and copy & paste the BibTeX code into your `.bib-file`. As a next step, you have to specify the location of the `.bib-file` in the YAML metadata (YAML parameter `bibliography:<.bib file>`). Now you can use the BibTeX reference sources from `.bib` in your R Markdown file. Insert `@` and the first BibTeX parameter of a BibTeX reference source to add citations to your document (see Fig. \@ref(fig:L09-refs)).

```{r L09-refs, echo=FALSE, fig.cap="Integrate BibTeX reference in RMarkdown document", out.width='90%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/refs.png')
```

To compile your R Markdown document, `knit` as `HTML`, `PDF` or `Word`. The `rmarkdown` library renders references as indirect citations (*reference without squared brackets in `.Rmd` file*) and direct citations (*reference with squared brackets in `.Rmd` file*) and inserts a bibliography (see Fig. \@ref(fig:L09-pdfknit)).

```{r L09-pdfknit, echo=FALSE, fig.cap="Knit R Markdown as PDF", out.width='90%', fig.asp=.75, fig.align='center'}
knitr::include_graphics('images/knit_pdf.png')
```

[Here](data/ReferencesInRMarkdown.zip){target="_blank"} you can find a worked example for download. Unzip the folder and open the `.Rproj` file in RStudio.

```{block2, type = 'rmdtip'}
Other helpful R Markdown syntax examples can be looked up in the [RMarkdown Cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf){target="_blank"}.
```

## Speed up your workflows

Many of the methods that were covered in this module **are intended to make repetitive workflows more efficient** and less time-consuming. In this section, an example is introduced that illustrates the great potentials of R Markdown in terms of automation and efficiency improvement.

Imagine you have a client who is interested in a specific set of spatial economic indicators that are updated daily. Rather than creating a data report from scratch every day, R Markdown allows you to create a data report with charts that are automatically generated on report compilation. This can save you a significant amount of time and effort, and allow you to focus on other tasks.

Data can be retrieved in real-time by means of [Alpha Ventage](https://www.alphavantage.co/){target="_blank"}. Alpha Ventage provides financial market data through the [Alpha Ventage Rest API](https://www.alphavantage.co/documentation/){target="_blank"}. To access the API in R, we can use the R library [`alphaventager`](https://cran.r-project.org/web/packages/alphavantager/index.html){target="_blank"}.

```{block2, type = 'rmdexercise'}

In this exercise you are provided with a first draft version of the finance data report. [Download](data/RMarkdownFinanceData.zip){target="_blank"} the draft version. Unzip the folder and open the `.Rproj` file in RStudio. 

The project includes a `.bib` file that contains a BibTeX reference, a `.csv` file (see folder data) with more than 400 country names, national currencies and currency codes and an `.Rmd` file with inline R code that renders real-time currency exchange in a map.

Carefully read through the `.Rmd` file **before you compile an HTML output**.

**Important:** The `.Rmd` file includes an interactive leaflet map, i.e. other outputs than HTML are not supported.

Once you have understood the structure of this document, try to supplement the finance data report with an additional spatial indicator (e.g. map of exchange rates from national currencies to Euro).

```


## Self-study

The functionality of R Markdown is comprehensive and **cannot be covered** in one lesson. It is highly recommended to consult the online book [R Markdown: The Definitive Guide](https://bookdown.org/yihui/rmarkdown/){target="_blank"} to leverage the full potential of R Markdown.

Other R Markdown compile formats that are described in this book are Notebooks and Presentations. RMarkdown also supports other languages such as Python, C++ and SQL. It can also be customized and used to create more complex documents with extensions like: [BookDown](https://bookdown.org/){target="_blank"} or [ThesisDown](https://github.com/ismayc/thesisdown){target="_blank"}. It is **recommended to practice and experiment** with these different features to become proficient in using R Markdown.

```{block2, type = 'rmdtip'}
By the way, this module is written in BookDown.
```



